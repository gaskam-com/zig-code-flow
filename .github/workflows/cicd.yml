name: Publish Extension

on:
  pull_request:
    types: [closed]
    branches:
      - master
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  initialize:
    if: github.event.pull_request.merged == true || github.event_name == 'release'
    runs-on: ubuntu-latest
    outputs:
      INIT_DONE: ${{ steps.mark_init.outputs.INIT_DONE }}

    steps:
      # Install jq for JSON parsing and manipulation
      - name: Install jq
        run: sudo apt-get install -y jq
      
      # Fetch the latest code from the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Configure Git identity for automated commits
      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # Set up Node.js environment for VSCode extension development
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Ensure package.json is valid and well-formed
      - name: Validate package.json
        run: jq . package.json > /dev/null

      # Install project dependencies from package.json
      - name: Install dependencies
        run: npm install

      # Mark initialization as done
      - name: Mark initialization as done
        id: mark_init
        run: echo "INIT_DONE=true" >> $GITHUB_OUTPUT

  version-management:
    needs: [initialize]
    if: github.event.pull_request.merged == true || github.event_name == 'release'
    runs-on: ubuntu-latest
    outputs:
      VERSION_DONE: ${{ steps.mark_version.outputs.VERSION_DONE }}
      VERSION: ${{ steps.set_version.outputs.VERSION }}

    steps:
      - uses: actions/checkout@v4

      - name: Set version based on event
        id: set_version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION=$(echo "${{ github.event.release.tag_name }}" | sed 's/^v//')
          else
            # Get current version
            CURRENT_VERSION=$(jq -r .version package.json)
            
            # Determine increment type from PR
            INCREMENT="patch"
            if echo "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }}" | grep -qi '\[major\]'; then
              INCREMENT="major"
            elif echo "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }}" | grep -qi '\[minor\]'; then
              INCREMENT="minor"
            fi
            
            # Bump version and get new version
            npm version $INCREMENT
            VERSION=$(jq -r .version package.json)
            
            # Create GitHub Release for PR merge
            gh release create "v$VERSION" \
              --title "Release $VERSION" \
              --generate-notes \
              --latest
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark version work as done
        id: mark_version
        run: echo "VERSION_DONE=true" >> $GITHUB_OUTPUT

  push:
    needs: [version-management]
    if: needs.version-management.outputs.VERSION_DONE == 'true'
    runs-on: ubuntu-latest
    outputs:
      MASTER_PUSH_DONE: ${{ steps.mark_push.outputs.MASTER_PUSH_DONE }}

    steps:
      - uses: actions/checkout@v4
      
      # Ensure version follows semantic versioning (MAJOR.MINOR.PATCH)
      - name: Validate version format
        run: |
          VERSION="${{ needs.version-management.outputs.VERSION }}"
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi

      # Update package.json with new version and handle potential errors
      - name: Update version
        run: |
          VERSION="${{ needs.version-management.outputs.VERSION }}"
          if ! jq ".version = \"$VERSION\"" package.json > tmp.json; then
            echo "::error::Failed to update package.json"
            exit 1
          fi
          mv tmp.json package.json
          npm install

      # Commit version changes to master
      - name: Commit version changes
        run: |
          git add package.json
          git commit -a -m "Bump version to v$VERSION"

      # Push new version to master
      - name: Push version changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.WORKFLOW_TOKEN }}
          branch: ${{ github.ref }}
          force: true

      - name: Mark master push as done
        id: mark_push
        run: echo "MASTER_PUSH_DONE=true" >> $GITHUB_OUTPUT

  publish:
    needs: [push]
    if: needs.push.outputs.MASTER_PUSH_DONE == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install dependencies
        run: npm install

      # Ensure VS Marketplace authentication token is available
      - name: Verify marketplace token
        run: |
          if [ -z "${{ secrets.VS_MARKETPLACE_TOKEN }}" ]; then
            echo "::error::Marketplace token missing. Add VS_MARKETPLACE_TOKEN in repository secrets."
            exit 1
          fi

      # Publish extension to VS Code Marketplace using provided token
      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v1.6.2
        with:
          pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
          registryUrl: https://marketplace.visualstudio.com
